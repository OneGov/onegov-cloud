#!/usr/bin/env bash
set -euo pipefail

SELF="$( cd "$(dirname "$0")" ; pwd -P )"
REPO="$(dirname "$SELF")"

# The following block ontains the Sentry Auth token to announce releases on
# sentry.io. This has been encrypted as follows:
#
# echo "my-token" | gpg --encrypt --armor \
#   --recipient fabian.reinhard@seantis.ch \
#   --recipient tobias.reinhard@seantis.ch \
#   --recipient chantal.trutmann@seantis.ch \
#   --recipient david.salvisberg@seantis.ch \
#   --recipient claudio.pilotti@seantis.ch \
#   --recipient cyrill.kuettel@seantis.ch \
#   --recipient reto.tschuppert@seantis.ch
#
# Be sure to update `configure-sentry` below and update the comment above
# if the intended recipients change. You will also want to create a new
# token with only the permission "project:releases" at that point and invalidate the old one:
#
#   https://sentry.io/settings/account/api/auth-tokens/
#
SENTRY_TOKEN_ENCRYPTED="
-----BEGIN PGP MESSAGE-----

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
ZOLQOxAV7SAObgA0VfJbQVW7lxvBmrVq/3o=
=Dmk0
-----END PGP MESSAGE-----
"

function configure-sentry() {
    SENTRY_AUTH_TOKEN="$(\
        echo "$SENTRY_TOKEN_ENCRYPTED" | gpg --decrypt --quiet
    )"

    export SENTRY_ORG="seantis-gmbh"
    export SENTRY_AUTH_TOKEN
}

function current-version() {
    git tag --sort=version:refname --merged master | tail -n 1
}

function announce-release-on-sentry-io() {
    local version="$1"
    local current_commit="$2"
    local previous_commit="$3"

    curl "https://sentry.io/api/0/organizations/${SENTRY_ORG}/releases/" \
        -X POST \
        -H "Authorization: Bearer ${SENTRY_AUTH_TOKEN}" \
        -H 'Content-Type: application/json' \
        -d "{
            \"version\": \"${version}\",
            \"refs\": [{
                \"repository\":\"OneGov/onegov-cloud\",
                \"commit\":\"${current_commit}\",
                \"previousCommit\":\"${previous_commit}\"
            }],
            \"projects\": [\"onegov-cloud\"]
        }"
}

function new-version() {
    local version
    version="$(current-version)"

    local year
    year="$(date +"%Y")"

    local build

    if echo "${version}" | grep "release-${year}" -q; then
        build="$(echo "${version}" | awk -F '.' '{print $NF}')"
    else
        build="0"
    fi

    echo "release-$year.$((build + 1))"
}

function release() {
    git fetch --quiet

    if ! git diff origin/master --exit-code --quiet; then
        echo "There are unpulled/unpushed remote changes, please update before release"
        exit 1
    fi

    if [[ "$(git branch --show-current)" != "master" ]]; then
        echo "A release can only be created on the master"
        exit 1
    fi

    current=$(current-version)
    new=$(new-version)
    short="${new/release-/}"

    echo "Releasing $new (previous: $current)"
    "$SELF"/changes "$new" > "$REPO/CHANGES.md"
    sed -i.bak "s/__version__.*/__version__ = '${short}'/g" src/onegov/core/__init__.py
    rm src/onegov/core/__init__.py.bak

    pushd "$REPO" > /dev/null
    git add CHANGES.md
    git add src/onegov/core/__init__.py
    git commit --no-verify -m "Release $(new-version)"
    git tag "$(new-version)"
    git push
    git push --tags
    popd > /dev/null

    local previous_commit
    previous_commit="$(git rev-list -n 1 "$current")"

    local current_commit
    current_commit="$(git rev-parse --verify HEAD)"

    announce-release-on-sentry-io "onegov-cloud:${new}" "$current_commit" "$previous_commit"
}

configure-sentry
release

#!/usr/bin/env bash
set -euo pipefail

SELF="$( cd "$(dirname "$0")" ; pwd -P )"
REPO="$(dirname "$SELF")"

# The following block ontains the Sentry Auth token to announce releases on
# sentry.io. This has been encrypted as follows:
#
# echo "my-token" | gpg --encrypt --armor \
#   --recipient patrick.bucher@seantis.ch \
#   --recipient fabian.reinhard@seantis.ch \
#   --recipient tobias.reinhard@seantis.ch \
#   --recipient marc.sommerhalder@seantis.ch \
#   --recipient chantal.trutmann@seantis.ch \
#   --recipient david.salvisberg@seantis.ch \
#   --recipient claudio.pilotti@seantis.ch
#
# Be sure to update `configure-sentry` below and update the comment above
# if the intended recipients change. You will also want to create a new
# token at that point and invalidate the old one:
#
#   https://sentry.io/settings/account/api/auth-tokens/
#
SENTRY_TOKEN_ENCRYPTED="
-----BEGIN PGP MESSAGE-----

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
=IIPI
-----END PGP MESSAGE-----

"

function configure-sentry() {
    SENTRY_AUTH_TOKEN="$(\
        echo "$SENTRY_TOKEN_ENCRYPTED" | gpg --decrypt --quiet \
            --recipient patrick.bucher@seantis.ch \
            --recipient fabian.reinhard@seantis.ch \
            --recipient tobias.reinhard@seantis.ch \
            --recipient marc.sommerhalder@seantis.ch \
    )"

    export SENTRY_ORG="seantis-gmbh"
    export SENTRY_AUTH_TOKEN
}

function current-version() {
    git ls-remote --tags origin \
        | awk -F '/' '{print $NF}' \
        | sort --reverse --version-sort\
        | head -n 1
}

function announce-release-on-sentry-io() {
    local version="$1"
    local current_commit="$2"
    local previous_commit="$3"

    curl "https://sentry.io/api/0/organizations/${SENTRY_ORG}/releases/" \
        -X POST \
        -H "Authorization: Bearer ${SENTRY_AUTH_TOKEN}" \
        -H 'Content-Type: application/json' \
        -d "{
            \"version\": \"${version}\",
            \"refs\": [{
                \"repository\":\"OneGov/onegov-cloud\",
                \"commit\":\"${current_commit}\",
                \"previousCommit\":\"${previous_commit}\"
            }],
            \"projects\": [\"onegov-cloud\"]
        }"
}

function new-version() {
    local version
    version="$(current-version)"

    local year
    year="$(date +"%Y")"

    local build

    if echo "${version}" | grep "release-${year}" -q; then
        build="$(echo "${version}" | awk -F '.' '{print $NF}')"
    else
        build="0"
    fi

    echo "release-$year.$((build + 1))"
}

function release() {
    git fetch --quiet

    if ! git diff origin/master --exit-code --quiet; then
        echo "There are unpulled/unpushed remote changes, please update before release"
        exit 1
    fi

    if [[ "$(git branch --show-current)" != "master" ]]; then
        echo "A release can only be created on the master"
        exit 1
    fi

    current=$(current-version)
    new=$(new-version)
    short="${new/release-/}"

    echo "Releasing $new (previous: $current)"
    "$SELF"/changes "$new" > "$REPO/CHANGES.md"
    sed -i.bak "s/__version__.*/__version__ = '${short}'/g" src/onegov/core/__init__.py
    rm src/onegov/core/__init__.py.bak

    pushd "$REPO" > /dev/null
    git add CHANGES.md
    git add src/onegov/core/__init__.py
    git commit -m "Release $(new-version)"
    git tag "$(new-version)"
    git push
    git push --tags
    popd > /dev/null

    local previous_commit
    previous_commit="$(git rev-list -n 1 "$current")"

    local current_commit
    current_commit="$(git rev-parse --verify HEAD)"

    announce-release-on-sentry-io "onegov-cloud:${new}" "$current_commit" "$previous_commit"
}

configure-sentry
release

#!/usr/bin/env bash
set -euo pipefail

SELF="$( cd "$(dirname "$0")" ; pwd -P )"
REPO="$(dirname "$SELF")"

# The following block ontains the Sentry Auth token to announce releases on
# sentry.io. This has been encrypted as follows:
#
# echo "my-token" | gpg --encrypt --armor \
#   --recipient patrick.bucher@seantis.ch \
#   --recipient fabian.reinhard@seantis.ch \
#   --recipient tobias.reinhard@seantis.ch \
#   --recipient marc.sommerhalder@seantis.ch
#
# Be sure to update `configure-sentry` below and update the comment above
# if the intended recipients change. You will also want to create a new
# token at that point and invalidate the old one:
#
#   sentry.io/settings/seantis-gmbh/projects/onegov-cloud/release-tracking/
#
SENTRY_TOKEN_ENCRYPTED="
-----BEGIN PGP MESSAGE-----

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
gsNE/aA4BRzOvw==
=L/N/
-----END PGP MESSAGE-----
"

function configure-sentry() {
    SENTRY_AUTH_TOKEN="$(\
        echo "$SENTRY_TOKEN_ENCRYPTED" | gpg --decrypt --quiet \
            --recipient patrick.bucher@seantis.ch \
            --recipient fabian.reinhard@seantis.ch \
            --recipient tobias.reinhard@seantis.ch \
            --recipient marc.sommerhalder@seantis.ch \
    )"

    export SENTRY_ORG="seantis-gmbh"
    export SENTRY_AUTH_TOKEN
}

function current-version() {
    git ls-remote --tags origin \
        | awk -F '/' '{print $NF}' \
        | sort --reverse --version-sort\
        | head -n 1
}

function announce-release-on-sentry-io() {
    local version="$1"
    local current_commit="$2"
    local previous_commit="$3"

    curl "https://sentry.io/api/0/organizations/${SENTRY_ORG}/releases/" \
        -X POST \
        -H "Authorization: Bearer ${SENTRY_AUTH_TOKEN}" \
        -H 'Content-Type: application/json' \
        -d "{
            \"version\": \"${version}\",
            \"refs\": [{
                \"repository\":\"OneGov/onegov-cloud\",
                \"commit\":\"${current_commit}\",
                \"previousCommit\":\"${previous_commit}\"
            }],
            \"projects\": [\"onegov-cloud\"]
        }"
}

function new-version() {
    local version
    version="$(current-version)"

    local year
    year="$(date +"%Y")"

    local build

    if echo "${version}" | grep "release-${year}" -q; then
        build="$(echo "${version}" | awk -F '.' '{print $NF}')"
    else
        build="0"
    fi

    echo "release-$year.$((build + 1))"
}

function release() {
    git fetch --quiet

    if ! git diff origin/master --exit-code --quiet; then
        echo "There are unpulled/unpushed remote changes, please update before release"
        exit 1
    fi

    if [[ "$(git branch --show-current)" != "master" ]]; then
        echo "A release can only be created on the master"
        exit 1
    fi

    current=$(current-version)
    new=$(new-version)
    short="${new/release-/}"

    echo "Releasing $new (previous: $current)"
    "$SELF"/changes "$new" > "$REPO/CHANGES.md"
    sed -i.bak "s/__version__.*/__version__ = '${short}'/g" src/onegov/core/__init__.py
    rm src/onegov/core/__init__.py.bak

    pushd "$REPO" > /dev/null
    git add CHANGES.md
    git add src/onegov/core/__init__.py
    git commit -m "Release $(new-version)"
    git tag "$(new-version)"
    git push
    git push --tags
    popd > /dev/null

    local previous_commit
    previous_commit="$(git rev-list -n 1 "$current")"

    local current_commit
    current_commit="$(git rev-parse --verify HEAD)"

    announce-release-on-sentry-io "onegov-cloud:${new}" "$current_commit" "$previous_commit"
}

configure-sentry
release

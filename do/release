#!/usr/bin/env bash
set -euo pipefail

SELF="$( cd "$(dirname "$0")" ; pwd -P )"
REPO="$(dirname "$SELF")"

# The following block ontains the Sentry Auth token to announce releases on
# sentry.io. This has been encrypted as follows:
#
# echo "my-token" | gpg --encrypt --armor \
#   --recipient patrick.bucher@seantis.ch \
#   --recipient fabian.reinhard@seantis.ch \
#   --recipient tobias.reinhard@seantis.ch \
#   --recipient marc.sommerhalder@seantis.ch \
#   --recipient chantal.trutmann@seantis.ch
#
# Be sure to update `configure-sentry` below and update the comment above
# if the intended recipients change. You will also want to create a new
# token at that point and invalidate the old one:
#
#   https://sentry.io/settings/account/api/auth-tokens/
#
SENTRY_TOKEN_ENCRYPTED="
-----BEGIN PGP MESSAGE-----

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
Sk5+
=kdyb
-----END PGP MESSAGE-----
"

function configure-sentry() {
    SENTRY_AUTH_TOKEN="$(\
        echo "$SENTRY_TOKEN_ENCRYPTED" | gpg --decrypt --quiet \
            --recipient patrick.bucher@seantis.ch \
            --recipient fabian.reinhard@seantis.ch \
            --recipient tobias.reinhard@seantis.ch \
            --recipient marc.sommerhalder@seantis.ch \
    )"

    export SENTRY_ORG="seantis-gmbh"
    export SENTRY_AUTH_TOKEN
}

function current-version() {
    git ls-remote --tags origin \
        | awk -F '/' '{print $NF}' \
        | sort --reverse --version-sort\
        | head -n 1
}

function announce-release-on-sentry-io() {
    local version="$1"
    local current_commit="$2"
    local previous_commit="$3"

    curl "https://sentry.io/api/0/organizations/${SENTRY_ORG}/releases/" \
        -X POST \
        -H "Authorization: Bearer ${SENTRY_AUTH_TOKEN}" \
        -H 'Content-Type: application/json' \
        -d "{
            \"version\": \"${version}\",
            \"refs\": [{
                \"repository\":\"OneGov/onegov-cloud\",
                \"commit\":\"${current_commit}\",
                \"previousCommit\":\"${previous_commit}\"
            }],
            \"projects\": [\"onegov-cloud\"]
        }"
}

function new-version() {
    local version
    version="$(current-version)"

    local year
    year="$(date +"%Y")"

    local build

    if echo "${version}" | grep "release-${year}" -q; then
        build="$(echo "${version}" | awk -F '.' '{print $NF}')"
    else
        build="0"
    fi

    echo "release-$year.$((build + 1))"
}

function release() {
    git fetch --quiet

    if ! git diff origin/master --exit-code --quiet; then
        echo "There are unpulled/unpushed remote changes, please update before release"
        exit 1
    fi

    if [[ "$(git branch --show-current)" != "master" ]]; then
        echo "A release can only be created on the master"
        exit 1
    fi

    current=$(current-version)
    new=$(new-version)
    short="${new/release-/}"

    echo "Releasing $new (previous: $current)"
    "$SELF"/changes "$new" > "$REPO/CHANGES.md"
    sed -i.bak "s/__version__.*/__version__ = '${short}'/g" src/onegov/core/__init__.py
    rm src/onegov/core/__init__.py.bak

    pushd "$REPO" > /dev/null
    git add CHANGES.md
    git add src/onegov/core/__init__.py
    git commit -m "Release $(new-version)"
    git tag "$(new-version)"
    git push
    git push --tags
    popd > /dev/null

    local previous_commit
    previous_commit="$(git rev-list -n 1 "$current")"

    local current_commit
    current_commit="$(git rev-parse --verify HEAD)"

    announce-release-on-sentry-io "onegov-cloud:${new}" "$current_commit" "$previous_commit"
}

configure-sentry
release

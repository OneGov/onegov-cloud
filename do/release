#!/usr/bin/env bash
set -euo pipefail

SELF="$( cd "$(dirname "$0")" ; pwd -P )"
REPO="$(dirname "$SELF")"

# The following block ontains the Sentry Auth token to announce releases on
# sentry.io. This has been encrypted as follows:
#
# echo "my-token" | gpg --encrypt --armor \
#   --recipient patrick.bucher@seantis.ch \
#   --recipient fabian.reinhard@seantis.ch \
#   --recipient tobias.reinhard@seantis.ch \
#   --recipient marc.sommerhalder@seantis.ch \
#   --recipient chantal.trutmann@seantis.ch \
#   --recipient david.salvisberg@seantis.ch \
#   --recipient claudio.pilotti@seantis.ch
#
# Be sure to update `configure-sentry` below and update the comment above
# if the intended recipients change. You will also want to create a new
# token with only the permission "project:releases" at that point and invalidate the old one:
#
#   https://sentry.io/settings/account/api/auth-tokens/
#
SENTRY_TOKEN_ENCRYPTED="
-----BEGIN PGP MESSAGE-----

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
=qKTF
-----END PGP MESSAGE-----
"

function configure-sentry() {
    SENTRY_AUTH_TOKEN="$(\
        echo "$SENTRY_TOKEN_ENCRYPTED" | gpg --decrypt --quiet
    )"

    export SENTRY_ORG="seantis-gmbh"
    export SENTRY_AUTH_TOKEN
}

function current-version() {
    git ls-remote --tags origin \
        | awk -F '/' '{print $NF}' \
        | sort --reverse --version-sort\
        | head -n 1
}

function announce-release-on-sentry-io() {
    local version="$1"
    local current_commit="$2"
    local previous_commit="$3"

    curl "https://sentry.io/api/0/organizations/${SENTRY_ORG}/releases/" \
        -X POST \
        -H "Authorization: Bearer ${SENTRY_AUTH_TOKEN}" \
        -H 'Content-Type: application/json' \
        -d "{
            \"version\": \"${version}\",
            \"refs\": [{
                \"repository\":\"OneGov/onegov-cloud\",
                \"commit\":\"${current_commit}\",
                \"previousCommit\":\"${previous_commit}\"
            }],
            \"projects\": [\"onegov-cloud\"]
        }"
}

function new-version() {
    local version
    version="$(current-version)"

    local year
    year="$(date +"%Y")"

    local build

    if echo "${version}" | grep "release-${year}" -q; then
        build="$(echo "${version}" | awk -F '.' '{print $NF}')"
    else
        build="0"
    fi

    echo "release-$year.$((build + 1))"
}

function release() {
    git fetch --quiet

    if ! git diff origin/master --exit-code --quiet; then
        echo "There are unpulled/unpushed remote changes, please update before release"
        exit 1
    fi

    if [[ "$(git branch --show-current)" != "master" ]]; then
        echo "A release can only be created on the master"
        exit 1
    fi

    current=$(current-version)
    new=$(new-version)
    short="${new/release-/}"

    echo "Releasing $new (previous: $current)"
    "$SELF"/changes "$new" > "$REPO/CHANGES.md"
    sed -i.bak "s/__version__.*/__version__ = '${short}'/g" src/onegov/core/__init__.py
    rm src/onegov/core/__init__.py.bak

    pushd "$REPO" > /dev/null
    git add CHANGES.md
    git add src/onegov/core/__init__.py
    git commit -m "Release $(new-version)"
    git tag "$(new-version)"
    git push
    git push --tags
    popd > /dev/null

    local previous_commit
    previous_commit="$(git rev-list -n 1 "$current")"

    local current_commit
    current_commit="$(git rev-parse --verify HEAD)"

    announce-release-on-sentry-io "onegov-cloud:${new}" "$current_commit" "$previous_commit"
}

configure-sentry
release

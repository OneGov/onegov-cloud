#!/usr/bin/env bash
set -euo pipefail

SELF="$( cd "$(dirname "$0")" ; pwd -P )"
REPO="$(dirname "$SELF")"

# The following block ontains the Sentry Auth token to announce releases on
# sentry.io. This has been encrypted as follows:
#
# echo "my-token" | gpg --encrypt --armor \
#   --recipient patrick.bucher@seantis.ch \
#   --recipient fabian.reinhard@seantis.ch \
#   --recipient tobias.reinhard@seantis.ch \
#   --recipient marc.sommerhalder@seantis.ch
#
# Be sure to update `configure-sentry` below and update the comment above
# if the intended recipients change. You will also want to create a new
# token at that point and invalidate the old one:
#
#   https://sentry.io/settings/account/api/auth-tokens/
#
SENTRY_TOKEN_ENCRYPTED="
-----BEGIN PGP MESSAGE-----

hQEMAyLmeAatF6VUAQgAhqa8gTY6HwC/dK3b82kC92PUN3eIiUyeKH27jAUvkv9h
rMLiNg4mW2GRDVd9g87fUT8x9uTeTc5dFYxIGsQKh6a1fqJ2PsvBp9gxVt0+lnI1
DW42q8oDV7VwKyXko+tN4cgifZ1zQQUNSuczjdVtWnZz2+Ey0KYnVSB9B/5Tn3xF
mc4COrdNDY812Zob7rg80UFLq3q3xhIKO4kz9hf0M5NQt84GNoGOSg9zn2QuH6xk
i5kmk6Lz3Z2Hs7ugXCuJMlnlyohgCEv1YuLTKzm1kMKzWP9GGmObtWqG7/Vy2/q+
paJ4i5AXqk6PPznjE1ZlG++fqbTjoVEEHOppt4uK/YUBDAMHz+95imlnAQEH/3+L
VJo/S/GZV8E6ZUKYyj1rojiNWh9Jm1RyjAfLCgP0PFFL2EYTFuOVv829p+GGHM8C
TnKoKidWuUH+WGAAIztW8MF8knTT2RoOSkaDYZqYGdJz1usQBVC4gJIQRh4WkFsz
xqIAZIElfDH17A77sVmzY5LNaoPUYO5M42ef0TG+RLmuV4W1q2HEz1J9J8m/twpT
0Sx1i/T0VEQDsTz8kkA8I50RMnH1B3sgWO8r/9dvDW2XNocdT9cTwaVVe8agb22w
9wL8QQ75DpcHwApwuFIENY52JJezy269d+lX1FFhCaFXeXKUGfAmysa8M2vyy62C
eX/K6INhdAbfpQX8NYaFAgwDMJDZ/6vvFCIBEADUfCIvqz4bSMdAL2AnJCrNBByY
f2XXervgbkBMie/S0FhSvtNTqbng6siZhj7vg1D7Gt9osKFqK2RoWeUYnvHpkMBk
p18EJ89C1ta8yoh+gCZH36OZDZA68dG6TdNF/Sn05ssF3e9U1C5OdawCI5VwpM7T
dwYY0D2Kbpp4MltFCKwNVtp/U+OjL7UtUe/Sg5H7dMgrqJ4JUoNnCNLLv34bOwkK
5eN3kExs+LwMqEykrMOw/yliR+S65ImAh8Q+FmpabVBPxfGzPiAj/mqSP8lLPK5j
buEYRP+rr7XLyGaTJFpWh+N8VPVV+uiuqoipEGISOAQ0NYst0NmpcQt2hMw9YwMA
64toFbIMYtnN4N0TfbYhmfScZEZYSUcMGlyFzzZG5420hk7hdLnnFRMsrTypwCG5
U3qYRhqjSxFQKpjPVY2SOh4xUAiYHrY+QRgVxdIOacXzEtCfEttg0CLqL3H+29ID
pG7qKjsoomlqGX5cSDcZ8AR24EAnpC4kFe4w7rE4kI0d3gTlG71pHhNR6WbOSMyL
rwHlNdR7IXyNYH/1fd02+/m1n/rGaxPJ74Xee3lhgWkVssZ4hdeju+nmjSt2KaWY
oQ5XH0/eo52wLgIU9PdPFjQyEapMcwlTn7wAbyMiJut9kYZwbpRNfVsTHQ1nt7r5
drm18KgSZ8MJaR2WVIUCDAPZogRArddtBAEP/RfPulF+6eNe5qA3Pr8EHjl7ybPa
Djdofky7TPIXSTL+ZbzTZqYp9vh0qZtRkxMZqvyjHVhVhtcnAs9a55v9p8uMPn1A
V4WuAoujsLh4cDHGWqKuvJ7dlFmS2SnkIgSVziIeu4x57vFoRqzfI0xlmz6bYJFs
Ryc/BUlPpxXIe36zyB22K/kpASn93Fzca1fHdyp96VVttor/1oOvW1dk/uUI6kbi
ZanjEyfM8K8awABLL6kIDlna0fdOEp7y6N9yIoRNl6Ukvs7mRHCfJ32dQLwT7me2
obfe40UCGgsC/EHrv+jEOtS6KudmCRT4sUn6cBX8Lzuy1QudtgzoZlxvQgzH4HHJ
N4ExFfNlEZkH2bvDqkjiiMpNsYEN0RgoW2E0eXGk+iD04mipfDyzVGDOZb0weajk
F12Xdq+3gIa3Hos/7fuRZ32ckIX7FQzxXRC50inhH2iTyjEDe7yT4ST3tGqnMTJm
yXz1tbQEao+3rZXEqf73qZF0DEtViIVu6RvzSYhoPaR9VwJMvlvMXuTWdqWVe1z2
bUrkDPErsXv5CkKcGBaRuKlgRKvang2ddXhv071kz7zrVursGBaNICIeqDJFUoOk
UT2+HLwfqZRDMBLW2SJvmAs813HkjuKwKmmZ3hBhVj6P0omYyBLERUR8xIjCcvbK
3BIz810yYsmkj3o40nIBbCGEgwSBtyXQvqCOoeiBFRnXRkq92Nb+fLgrPiPJjuGQ
wZ5U0GD0Jq8oPjHgSpkzqEzVv8t1XCrWwSeFsI01NQe688IaopixvMiApAwa7kS3
poytTQWa4qnwWiH7m/L1F8NnE69zxpe+3qmdrd92nwY=
=UBG+
-----END PGP MESSAGE-----
"

function configure-sentry() {
    SENTRY_AUTH_TOKEN="$(\
        echo "$SENTRY_TOKEN_ENCRYPTED" | gpg --decrypt --quiet \
            --recipient patrick.bucher@seantis.ch \
            --recipient fabian.reinhard@seantis.ch \
            --recipient tobias.reinhard@seantis.ch \
            --recipient marc.sommerhalder@seantis.ch \
    )"

    export SENTRY_ORG="seantis-gmbh"
    export SENTRY_AUTH_TOKEN
}

function current-version() {
    git ls-remote --tags origin \
        | awk -F '/' '{print $NF}' \
        | sort --reverse --version-sort\
        | head -n 1
}

function announce-release-on-sentry-io() {
    local version="$1"
    local current_commit="$2"
    local previous_commit="$3"

    curl "https://sentry.io/api/0/organizations/${SENTRY_ORG}/releases/" \
        -X POST \
        -H "Authorization: Bearer ${SENTRY_AUTH_TOKEN}" \
        -H 'Content-Type: application/json' \
        -d "{
            \"version\": \"${version}\",
            \"refs\": [{
                \"repository\":\"OneGov/onegov-cloud\",
                \"commit\":\"${current_commit}\",
                \"previousCommit\":\"${previous_commit}\"
            }],
            \"projects\": [\"onegov-cloud\"]
        }"
}

function new-version() {
    local version
    version="$(current-version)"

    local year
    year="$(date +"%Y")"

    local build

    if echo "${version}" | grep "release-${year}" -q; then
        build="$(echo "${version}" | awk -F '.' '{print $NF}')"
    else
        build="0"
    fi

    echo "release-$year.$((build + 1))"
}

function release() {
    git fetch --quiet

    if ! git diff origin/master --exit-code --quiet; then
        echo "There are unpulled/unpushed remote changes, please update before release"
        exit 1
    fi

    if [[ "$(git branch --show-current)" != "master" ]]; then
        echo "A release can only be created on the master"
        exit 1
    fi

    current=$(current-version)
    new=$(new-version)
    short="${new/release-/}"

    echo "Releasing $new (previous: $current)"
    "$SELF"/changes "$new" > "$REPO/CHANGES.md"
    sed -i.bak "s/__version__.*/__version__ = '${short}'/g" src/onegov/core/__init__.py
    rm src/onegov/core/__init__.py.bak

    pushd "$REPO" > /dev/null
    git add CHANGES.md
    git add src/onegov/core/__init__.py
    git commit -m "Release $(new-version)"
    git tag "$(new-version)"
    git push
    git push --tags
    popd > /dev/null

    local previous_commit
    previous_commit="$(git rev-list -n 1 "$current")"

    local current_commit
    current_commit="$(git rev-parse --verify HEAD)"

    announce-release-on-sentry-io "onegov-cloud:${new}" "$current_commit" "$previous_commit"
}

configure-sentry
release

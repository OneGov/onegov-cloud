#!/usr/bin/env bash
set -euo pipefail

SELF="$( cd "$(dirname "$0")" ; pwd -P )"
REPO="$(dirname "$SELF")"

# The following block ontains the Sentry Auth token to announce releases on
# sentry.io. This has been encrypted as follows:
#
# echo "my-token" | gpg --encrypt --armor \
#   --recipient patrick.bucher@seantis.ch \
#   --recipient fabian.reinhard@seantis.ch \
#   --recipient tobias.reinhard@seantis.ch \
#   --recipient marc.sommerhalder@seantis.ch \
#   --recipient chantal.trutmann@seantis.ch \
#   --recipient david.salvisberg@seantis.ch \
#   --recipient claudio.pilotti@seantis.ch \
#   --recipient cyrill.kuettel@seantis.ch
#
# Be sure to update `configure-sentry` below and update the comment above
# if the intended recipients change. You will also want to create a new
# token with only the permission "project:releases" at that point and invalidate the old one:
#
#   https://sentry.io/settings/account/api/auth-tokens/
#
SENTRY_TOKEN_ENCRYPTED="
-----BEGIN PGP MESSAGE-----
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
=VgXW
-----END PGP MESSAGE-----
"

function configure-sentry() {
    SENTRY_AUTH_TOKEN="$(\
        echo "$SENTRY_TOKEN_ENCRYPTED" | gpg --decrypt --quiet
    )"

    export SENTRY_ORG="seantis-gmbh"
    export SENTRY_AUTH_TOKEN
}

function current-version() {
    git ls-remote --tags origin \
        | awk -F '/' '{print $NF}' \
        | sort --reverse --version-sort\
        | head -n 1
}

function announce-release-on-sentry-io() {
    local version="$1"
    local current_commit="$2"
    local previous_commit="$3"

    curl "https://sentry.io/api/0/organizations/${SENTRY_ORG}/releases/" \
        -X POST \
        -H "Authorization: Bearer ${SENTRY_AUTH_TOKEN}" \
        -H 'Content-Type: application/json' \
        -d "{
            \"version\": \"${version}\",
            \"refs\": [{
                \"repository\":\"OneGov/onegov-cloud\",
                \"commit\":\"${current_commit}\",
                \"previousCommit\":\"${previous_commit}\"
            }],
            \"projects\": [\"onegov-cloud\"]
        }"
}

function new-version() {
    local version
    version="$(current-version)"

    local year
    year="$(date +"%Y")"

    local build

    if echo "${version}" | grep "release-${year}" -q; then
        build="$(echo "${version}" | awk -F '.' '{print $NF}')"
    else
        build="0"
    fi

    echo "release-$year.$((build + 1))"
}

function release() {
    git fetch --quiet

    if ! git diff origin/master --exit-code --quiet; then
        echo "There are unpulled/unpushed remote changes, please update before release"
        exit 1
    fi

    if [[ "$(git branch --show-current)" != "master" ]]; then
        echo "A release can only be created on the master"
        exit 1
    fi

    current=$(current-version)
    new=$(new-version)
    short="${new/release-/}"

    echo "Releasing $new (previous: $current)"
    "$SELF"/changes "$new" > "$REPO/CHANGES.md"
    sed -i.bak "s/__version__.*/__version__ = '${short}'/g" src/onegov/core/__init__.py
    rm src/onegov/core/__init__.py.bak

    pushd "$REPO" > /dev/null
    git add CHANGES.md
    git add src/onegov/core/__init__.py
    git commit -m "Release $(new-version)"
    git tag "$(new-version)"
    git push
    git push --tags
    popd > /dev/null

    local previous_commit
    previous_commit="$(git rev-list -n 1 "$current")"

    local current_commit
    current_commit="$(git rev-parse --verify HEAD)"

    announce-release-on-sentry-io "onegov-cloud:${new}" "$current_commit" "$previous_commit"
}

configure-sentry
release

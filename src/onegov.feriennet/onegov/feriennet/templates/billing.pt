<div metal:use-macro="layout.base" i18n:domain="onegov.feriennet">
    <tal:block metal:fill-slot="title">
        ${title}
    </tal:block>
    <tal:block metal:fill-slot="content" tal:define="bills model.bills">

        <div class="callout panel">
            <div class="hints">
                <tal:block metal:use-macro="layout.macros.period_hints" />

                <div class="hint hint-costs" i18n:translate tal:condition="bills">
                    The total amount is <strong tal:content="'{:.2f}'.format(total)" i18n:name="amount" /> CHF.
                </div>

                <div class="hint hint-outstanding" i18n:translate tal:condition="bills">
                    The outstanding amount is <strong tal:content="'{:.2f}'.format(outstanding)" i18n:name="amount" /> CHF.
                </div>
            </div>
        </div>

        <div class="row">
            <div class="columns small-12 medium-8">
                <tal:block condition="not: bills" i18n:translate>No bills created yet.</tal:block>

                <div class="bills">
                    <div class="bill ${details.paid and 'paid' or 'unpaid'}" id="${details.id}" tal:repeat="(username, details) bills.items()" data-reload-from="${request.link(model.for_username(username))}" data-reload-from-selector=".bill">
                        <h3>${details.title}</h3>

                        <strong class="outstanding">
                            <tal:block condition="details.paid" i18n:translate>Paid</tal:block>
                            <tal:block condition="not: details.paid" i18n:translate>
                                <tal:block i18n:name="amount" tal:replace="'{:.2f}'.format(details.outstanding)" /> unpaid
                            </tal:block>

                            <tal:block tal:define="actions tuple(invoice_actions(details))" tal:condition="actions">
                                <a href="#" class="tiny button circle" data-dropdown="item-dropdown-${details.id}">
                                    <span i18n:translate class="show-for-sr">Actions</span>
                                    <i class="fa fa-wrench" aria-hidden="true"></i>
                                </a>
                                <ul id="item-dropdown-${details.id}" class="small f-dropdown" data-dropdown-content>
                                  <li tal:repeat="link actions">
                                      <tal:block replace="structure link(request)" />
                                  </li>
                                </ul>
                            </tal:block>
                        </strong>

                        <button id="button-${details.id}" data-toggle="#details-${details.id}" class="${model.expand and 'toggled' or 'untoggled'}">
                            <span i18n:translate class="show-for-sr">Show Details</span>
                            <i class="fa fa-angle-double-down" aria-hidden="true"></i>
                        </button>

                        <table id="details-${details.id}" class="invoice-items" style="${not model.expand and 'display: none;'}">
                            <thead class="show-for-sr">
                                <tr>
                                    <th i18n:translate>Booking Text</th>
                                    <th i18n:translate>Amount</th>
                                    <th i18n:translate>Paid</th>
                                    <th i18n:translate>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tal:block repeat="(group, groupitems) details.items.items()">
                                    <tr class="group">
                                        <td colspan="4">${group}</td>
                                    </tr>
                                    <tr class="${item.paid and 'paid' or 'unpaid'}" tal:repeat="item groupitems" tal:define="groupid hash(groupitems)">
                                        <td>${item.text}</td>
                                        <td class="amount">${'{:.2f}'.format(item.amount)}</td>
                                        <td class="payment-status" tal:condition="not item.paid">
                                            <span i18n:translate class="show-for-sr">Unpaid</span>
                                            <i class="fa fa-exclamation-triangle" aria-hidden="true"></i>
                                        </td>
                                        <td class="payment-status" tal:condition="item.paid">
                                            <span i18n:translate class="show-for-sr">Paid</span>
                                            <i class="fa fa-check-circle" aria-hidden="true"></i>
                                        </td>
                                        <td class="actions">
                                            <tal:block tal:define="actions tuple(item_actions(item))" tal:condition="actions">
                                                <a href="#" class="tiny button circle" data-dropdown="item-dropdown-${details.id}-${groupid}-${repeat.item.index}">
                                                    <span i18n:translate class="show-for-sr">Actions</span>
                                                    <i class="fa fa-wrench" aria-hidden="true"></i>
                                                </a>
                                                <ul id="item-dropdown-${details.id}-${groupid}-${repeat.item.index}" class="small f-dropdown" data-dropdown-content>
                                                    <li tal:repeat="link actions">
                                                        <tal:block replace="structure link(request)" />
                                                    </li>
                                                </ul>
                                            </tal:block>
                                        </td>
                                    </tr>
                                </tal:block>
                                <tr class="total">
                                    <td i18n:translate>Total</td>
                                    <td class="amount">
                                        ${'{:.2f}'.format(details.total)}
                                    </td>
                                    <td class="payment-status" tal:condition="not details.paid">
                                        <span i18n:translate class="show-for-sr">Unpaid</span>
                                        <i class="fa fa-exclamation-triangle" aria-hidden="true"></i>
                                    </td>
                                    <td class="payment-status" tal:condition="details.paid">
                                        <span i18n:translate class="show-for-sr">Paid</span>
                                        <i class="fa fa-check-circle" aria-hidden="true"></i>
                                    </td>
                                    <td></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="columns small-12 medium-4">
                <div class="page-content-panel form-panel">
                    <h4 i18n:translate>Billing</h4>

                    <tal:block condition="period.active and period.booking_phase">
                        <div metal:use-macro="layout.macros['form']" />
                    </tal:block>

                    <tal:block condition="period.active and not period.confirmed">
                        <p>
                            <i class="fa fa-lock fa-fw" aria-hidden="true"></i>
                            <span i18n:translate>
                                The matching of this period has not been confirmed yet.
                            </span>
                        </p>
                    </tal:block>

                    <tal:block condition="not period.active and not period.finalized">
                        <p>
                            <i class="fa fa-lock fa-fw" aria-hidden="true"></i>
                            <span i18n:translate>
                                This period is not active. Bills may only be created for the active period.
                            </span>
                        </p>
                    </tal:block>

                    <tal:block condition="period.finalized">
                        <p>
                            <i class="fa fa-lock fa-fw" aria-hidden="true"></i>
                            <span i18n:translate>
                                The billing for this period has been confirmed. You can still change the invoices manually but you can no longer generate them automatically.
                            </span>
                        </p>
                    </tal:block>
                </div>

                <tal:block metal:use-macro="layout.macros.periods" />
            </div>
        </div>
    </tal:block>
</div>

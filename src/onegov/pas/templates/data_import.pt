<div metal:use-macro="layout.base" i18n:domain="onegov.pas">
    <tal:b metal:fill-slot="title">
            ${title}
    </tal:b>
    <tal:b metal:fill-slot="content">
        <!-- Explicitly display form errors for debugging -->
        <div tal:condition="form.errors" class="callout alert">
            <p i18n:translate="">Please correct the errors below:</p>
            <ul>
                <li tal:repeat="field_errors form.errors.items()">
                    <strong tal:content="field_errors[0]" />:
                    <span tal:repeat="error field_errors[1]" tal:content="error" />
                </li>
            </ul>
        </div>

        <!-- After form submit, don't show the form again but show the import details. -->
        <div metal:use-macro="layout.macros['form']" tal:condition="form and not import_details" />

        <div tal:condition="error_message" class="callout alert import-error">
            <h4 i18n:translate="">Import Error</h4>
            <pre tal:content="error_message" />
        </div>

        <div tal:condition="import_details" class="import-results">
            <h4 i18n:translate="">Import Results</h4>

            <!-- Overall Summary -->
            <div class="callout primary"
                 tal:condition="total_processed > 0">
                 <p i18n:translate="msg_import_summary">
                    Processed ${processed} items in total: ${created} created, ${updated} updated.
                 </p>
            </div>
            <div class="callout primary"
                 tal:condition="total_processed == 0 and not error_message">
                 <p i18n:translate="">
                    No items were processed. The uploaded files might be empty or incorrectly formatted.
                 </p>
            </div>


            <!-- Detailed Breakdown per Category -->
            <tal:block repeat="category_name import_details.keys()">
                <tal:block define="details import_details[category_name];
                                  created details.get('created', []);
                                  updated details.get('updated', []);
                                  processed details.get('processed', 0);
                                  category_title category_name.replace('_', ' ').title()">

                    <!-- Section for Created Items -->
                    <div tal:condition="created" class="callout success">
                        <h5 i18n:translate="msg_category_created">
                            ${category} Created (${count}/${total})
                        </h5>
                        <ul>
                            <li tal:repeat="item created">
                                <a tal:attributes="href request.link(item)"
                                   tal:content="get_item_display_title(item)">
                                   <!-- Display title generated by helper -->
                                </a>
                            </li>
                        </ul>
                    </div>

                    <!-- Section for Updated Items -->
                    <div tal:condition="updated" class="callout warning">
                         <h5 i18n:translate="msg_category_updated">
                             ${category} Updated (${count}/${total})
                         </h5>
                        <ul>
                            <li tal:repeat="item updated">
                                 <a tal:attributes="href request.link(item)"
                                    tal:content="get_item_display_title(item)">
                                    <!-- Display title generated by helper -->
                                 </a>
                            </li>
                        </ul>
                    </div>

                     <!-- Notice if category was processed but had no changes -->
                     <div tal:condition="processed > 0 and not created and not updated"
                          class="callout secondary category-no-changes">
                          <h5 tal:content="string:${category_title} (${processed})"></h5>
                          <p i18n:translate="">No changes needed for this category.</p>
                     </div>

                </tal:block>
            </tal:block>
        </div>
    </tal:b>
</div>

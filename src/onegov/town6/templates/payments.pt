<div metal:use-macro="layout.base" i18n:domain="onegov.town6">
    <tal:b metal:fill-slot="title">
        ${title}
    </tal:b>
    <tal:b metal:fill-slot="content">
        <div metal:use-macro="layout.macros['form']" tal:define="form_two_columns True"/>
            <div class="filter-grid">
                <div class="form-buttons">
                    <button type="button" id="exportPaymentsButton" class="button" i18n:translate="">Export Bill run as PDF</button>
                    <tal:block tal:condition="payments">
                        <button type="button" class="button hollow batch-action-button" i18n:translate="">Ausgewählte als fakturiert markieren</button>
                    </tal:block>
                </div>
            </div>

        <p i18n:translate tal:condition="not payments">
            No payments yet.
        </p>

        <metal:b use-macro="layout.macros['payments']" />

        <div metal:use-macro="layout.macros['pagination']" tal:define="
            collection layout.model; current_page layout.model; pagination_centered True" />

    </tal:b>
    <tal:b metal:fill-slot="javascript">
        <script type="text/javascript">
            document.addEventListener('DOMContentLoaded', function() {
                const markInvoicedButton = document.querySelector('.batch-action-button');
                if (markInvoicedButton) {
                    markInvoicedButton.addEventListener('click', function() {
                        const selectedPayments = [];
                        document.querySelectorAll('input[name="selected_payments"]:checked').forEach(function(checkbox) {
                            selectedPayments.push(checkbox.value);
                        });

                        if (selectedPayments.length === 0) {
                            alert(document.documentElement.lang === 'de' ? 'Bitte wählen Sie mindestens eine Zahlung aus.' : 'Please select at least one payment.');
                            return;
                        }

                        fetch('${request.link(layout.model, "batch-mark-invoiced")}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-Token': '${layout.csrf_token}'
                            },
                            body: JSON.stringify({ payment_ids: selectedPayments })
                        })
                        .then(response => response.json())
                        .then(data => {
                            window.location.reload();
                        })
                        .catch(error => {
                            alert(document.documentElement.lang === 'de' ? 'Ein Fehler ist aufgetreten.' : 'An error occurred.');
                            console.error('Error:', error);
                        });
                    });
                }
            });
        </script>
    </tal:b>
</div>

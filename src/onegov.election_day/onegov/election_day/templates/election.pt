<div metal:use-macro="layout.base" i18n:domain="onegov.election_day">
    <tal:block metal:fill-slot="before-content">
        <h1>
            <small i18n:translate="" tal:condition="not: election.counted">Not yet counted.</small>
            ${election.title}
        </h1>

        <div class="download-results">
            <a data-dropdown="download-dropdown" data-options="align:left" aria-controls="download-dropdown" aria-expanded="false"><i class="fa fa-download"></i></a>
            <ul id="download-dropdown" class="f-dropdown" data-dropdown-content aria-hidden="true" tabindex="-1">
                <li><a href="${request.link(election, 'data-json')}">JSON</a></li>
                <li><a href="${request.link(election, 'data-csv')}">CSV</a></li>
                <li><a href="${request.link(election, 'data-xlsx')}">XLSX</a></li>
                <li><a href="${layout.opendata_link}"><em i18n:translate="">Format Description</em></a></li>
            </ul>
        </div>

        <hr />
    </tal:block>
    <tal:block metal:fill-slot="content">

        <div metal:use-macro="layout.macros['temporary_results_callout']" tal:define="last_change election.last_result_change; counted election.counted and has_results" />

        <tal:block tal:condition="has_results" tal:define="summarize election.total_entities!=1">

            <h2 i18n:translate="">Results</h2>

            <ul class="small-block-grid-1 medium-block-grid-4 factoids">
                <li>
                    <span i18n:translate="">Turnout</span>
                    <strong>${'{0:.2f}'.format(election.turnout)} %</strong>
                </li>

                <li>
                    <span i18n:translate="">Elegible Voters</span>
                    <strong>${layout.format_number(election.elegible_voters)}</strong>
                </li>

                <li>
                    <span i18n:translate="">Received Ballots</span>
                    <strong>${layout.format_number(election.received_ballots)}</strong>
                </li>

                <li>
                    <span i18n:translate="">Counted</span>
                    <strong><span metal:use-macro="layout.macros['progress']" tal:define="progress election.progress" /></strong>
                </li>

            </ul>

            <ul class="small-block-grid-1 medium-block-grid-4 factoids">
                <li>
                    <span i18n:translate="">Mandates</span>
                    <strong><span metal:use-macro="layout.macros['progress']" tal:define="progress (election.allocated_mandates, election.number_of_mandates)" /></strong>
                </li>

                <li tal:condition="majorz">
                    <span i18n:translate="">Absolute majority</span>
                    <strong tal:condition="election.absolute_majority">${layout.format_number(election.absolute_majority or 0)}</strong>
                </li>

            </ul>

            <div class="row" tal:condition="not: majorz">
                <div class="small-12 small-centered large-10 columns">
                    <div class="bar-chart" i18n:attributes="data-download-link; data-embed-link"
                        data-dataurl="${request.link(election, name='lists')}"
                        data-download-link="Download"
                        data-embed-link="Embed"
                        data-embed-source="${request.link(election, name='lists-chart')}"
                        />
                </div>
            </div>

            <div class="row" tal:condition="majorz">
                <div class="small-12 small-centered large-10 columns">
                    <div class="bar-chart" i18n:attributes="data-download-link; data-embed-link"
                        data-dataurl="${request.link(election, name='candidates')}"
                        data-download-link="Download"
                        data-embed-link="Embed"
                        data-embed-source="${request.link(election, name='candidates-chart')}">
                    </div>
                </div>
            </div>

            <div class="foldable" tal:condition="not: majorz">
                <h3 class="foldable-title" i18n:translate="">Candidates</h3>
                <div class="foldable-panel">
                    <table class="ballot-results stackable collapsible collapsed">
                        <thead>
                            <tr>
                                <th i18n:translate="">Candidate</th>
                                <th i18n:translate="single_votes" class="right-aligned">Votes</th>
                                <th i18n:translate="" class="right-aligned">List</th>
                                <th i18n:translate="" class="right-aligned">Elected</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr tal:repeat="candidate candidates" tal:attributes="class 'sticky' if candidate[2] > 0 else ''">
                                <td>${candidate[0]} ${candidate[1]}</td>
                                <td class="right-aligned">${layout.format_number(candidate[3])}</td>
                                <td class="right-aligned">${candidate[4]}</td>
                                <td class="answer accepted right-aligned" tal:condition="candidate[2] == True" i18n:translate="">Yes</td>
                                <td class="answer rejected right-aligned" tal:condition="candidate[2] == False" i18n:translate="">No</td>
                                <td class="answer right-aligned" tal:condition="candidate[2] == None" i18n:translate=""></td>
                            </tr>
                            <tr class="more">
                                <td colspan="4" i18n:translate="">All candidates</td>
                            </tr>
                            <tr class="less">
                                <td colspan="4" i18n:translate="">Elected candidates only</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="foldable folded" tal:condition="python: not majorz and connections">
                <h3 class="foldable-title" i18n:translate="">List connections</h3>
                <div class="foldable-svg-panel row">
                    <div class="small-12 small-centered medium-12 large-10 columns" tal:condition="connections">
                        <div class="sankey-chart" i18n:attributes="data-download-link; data-embed-link"
                            data-dataurl="${request.link(election, name='connections')}"
                            data-download-link="Download"
                            data-embed-link="Embed"
                            data-embed-source="${request.link(election, name='connections-chart')}">
                        </div>
                    </div>
                </div>
                <div class="foldable-panel">
                    <tal:block tal:repeat="connection connections">
                        <table class="ballot-results">
                            <thead>
                                <tr>
                                    <th><span i18n:translate="">List connection</span> ${connection[0]}</th>
                                    <th i18n:translate="single_votes" class="right-aligned">Votes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr tal:repeat="list connection[2]">
                                    <td>${list[0]}</td>
                                    <td class="right-aligned">${layout.format_number(list[1])}</td>
                                </tr>
                                <tal:block tal:repeat="subconnection connection[3]">
                                    <tr>
                                        <td><span i18n:translate="">Sublist connection</span> ${subconnection[0]}</td>
                                        <td></td>
                                    </tr>
                                    <tr tal:repeat="list subconnection[2]">
                                        <td>${list[0]}</td>
                                        <td class="right-aligned">${layout.format_number(int(list[1]))}</td>
                                    </tr>
                                    <tr class="subtotal">
                                        <td i18n:translate="">Subtotal</td>
                                        <td class="right-aligned">${layout.format_number(int(subconnection[1]))}</td>
                                    </tr>
                                </tal:block>
                                <tr class="total">
                                    <td i18n:translate="">Total</td>
                                    <td class="right-aligned">${layout.format_number(int(connection[1]))}</td>
                                </tr>
                            </tbody>
                        </table>
                    </tal:block>
                </div>
            </div>

            <div class="foldable folded" tal:condition="summarize and majorz">
                <h3 class="foldable-title" i18n:translate="">Electoral Districts</h3>
                <div class="foldable-panel">
                    <table class="ballot-results stackable">
                        <thead>
                            <tr>
                                <th i18n:translate="">Electoral District</th>
                                <th tal:repeat="candidate election.candidates" class="right-aligned">${candidate.family_name} ${candidate.first_name}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="total">
                                <td i18n:translate="">Total</td>
                                <td tal:repeat="candidate election.candidates" class="right-aligned">${layout.format_number(candidate.votes)}</td>
                            </tr>
                            <tr tal:repeat="result electoral">
                                <td>${result[0]}</td>
                                <td tal:repeat="candidate result[1]" class="right-aligned">${layout.format_number(candidate[1])}</td>
                            </tr>
                            <tr tal:repeat="entity missing_entities">
                                <td>${entity}</td>
                                <td i18n:translate="" tal:attributes="colspan number_of_candidates">Not yet counted.</td>
                            </tr>
                            <tr class="total">
                                <td i18n:translate="">Total</td>
                                <td tal:repeat="candidate election.candidates" class="right-aligned">${layout.format_number(candidate.votes)}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="foldable folded">
                <h3 class="foldable-title" i18n:translate="">Election statistics</h3>
                <div class="foldable-panel">
                    <table class="ballot-results stackable">
                        <thead>
                            <tr>
                                <th i18n:translate="">Electoral District</th>
                                <th i18n:translate="" class="right-aligned">Elegible Voters</th>
                                <th i18n:translate="" class="right-aligned">Received Ballots</th>
                                <th i18n:translate="" class="right-aligned">Accounted Ballots</th>
                                <th i18n:translate="" class="right-aligned">Blank Ballots</th>
                                <th i18n:translate="" class="right-aligned">Invalid Ballots</th>
                                <th i18n:translate="" class="right-aligned">Accounted Votes</th>
                                <th i18n:translate="" class="right-aligned" tal:condition="election.counted">Turnout</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="total" tal:condition="summarize">
                                <td i18n:translate="">Total</td>
                                <td class="right-aligned">${layout.format_number(election.elegible_voters)}</td>
                                <td class="right-aligned">${layout.format_number(election.received_ballots)}</td>
                                <td class="right-aligned">${layout.format_number(election.accounted_ballots)}</td>
                                <td class="right-aligned">${layout.format_number(election.blank_ballots)}</td>
                                <td class="right-aligned">${layout.format_number(election.invalid_ballots)}</td>
                                <td class="right-aligned">${layout.format_number(election.accounted_votes)}</td>
                                <td class="right-aligned" tal:condition="election.counted">${'{0:.2f}'.format(election.turnout)} %</td>
                            </tr>
                            <tr tal:repeat="result election.results">
                                <td>${result.group}</td>
                                <td class="right-aligned">${layout.format_number(result.elegible_voters)}</td>
                                <td class="right-aligned">${layout.format_number(result.received_ballots)}</td>
                                <td class="right-aligned">${layout.format_number(result.accounted_ballots)}</td>
                                <td class="right-aligned">${layout.format_number(result.blank_ballots)}</td>
                                <td class="right-aligned">${layout.format_number(result.invalid_ballots)}</td>
                                <td class="right-aligned">${layout.format_number(result.accounted_votes)}</td>
                                <td class="right-aligned" tal:condition="election.counted">${'{0:.2f}'.format(result.turnout)} %</td>
                            </tr>
                            <tr tal:repeat="entity missing_entities">
                                <td tal:condition="summarize">${entity}</td>
                                <td i18n:translate="" colspan="6">Not yet counted.</td>
                            </tr>
                            <tr class="total" tal:condition="summarize">
                                <td i18n:translate="">Total</td>
                                <td class="right-aligned">${layout.format_number(election.elegible_voters)}</td>
                                <td class="right-aligned">${layout.format_number(election.received_ballots)}</td>
                                <td class="right-aligned">${layout.format_number(election.accounted_ballots)}</td>
                                <td class="right-aligned">${layout.format_number(election.blank_ballots)}</td>
                                <td class="right-aligned">${layout.format_number(election.invalid_ballots)}</td>
                                <td class="right-aligned">${layout.format_number(election.accounted_votes)}</td>
                                <td class="right-aligned" tal:condition="election.counted">${'{0:.2f}'.format(election.turnout)} %</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </tal:block>

        <div metal:use-macro="layout.macros['related_link']" tal:define="meta election.meta" />

    </tal:block>
</div>

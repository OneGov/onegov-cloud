[build-system]
requires = ["setuptools>=42", "wheel"]
build-backend = "setuptools.build_meta"

[tool.pytest.ini_options]
log_level = "INFO"
testpaths = ["tests"]
timeout = 300

[tool.coverage.run]
data_file = "/tmp/.coverage"
include = ["*/onegov/*"]
omit = ["*/tests/*"]

[tool.coverage.report]
ignore_errors = true

[tool.mypy]
python_version = "3.10"
follow_imports = "silent"
namespace_packages = true
explicit_package_bases = true
warn_unused_ignores = true
warn_redundant_casts = true
plugins = "sqlmypy"
mypy_path = "$MYPY_CONFIG_FILE_DIR/src:$MYPY_CONFIG_FILE_DIR/stubs"

[[tool.mypy.overrides]]
# more strict rules for fully typed modules
module = [
    "onegov.core.browser_session.*",
    "onegov.core.cache.*",
    "onegov.core.collection.*",
    "onegov.core.crypto.*",
    "onegov.core.datamanager.*",
    "onegov.core.directives.*",
    "onegov.core.framework.*",
    "onegov.core.mail.*",
    "onegov.core.orm.*",
    "onegov.core.request.*",
    "onegov.core.security.*",
    "onegov.core.types.*",
    "onegov.core.utils.*"
]
warn_unreachable = true
disallow_any_generics = true
disallow_untyped_defs = true

[[tool.mypy.overrides]]
# ignore missing imports for packages that have no stubs available
module = [
    "alembic.*",
    "bjoern.*",
    "blinker.*",
    # FIXME: replace this with stdlib version that was added in 3.9?
    "cached_property.*",
    "chameleon.*",
    # FIXME: do we actually make good use of this?
    "colour.*",
    "cssutils.*",
    "elasticsearch_dsl.*",
    "dectate.*",
    "depot.*",
    "docxtpl.*",
    "dill.*",
    "dukpy.*",
    # FIXME: is this still faster than stdlib? it's not maintained
    "fastcache.*",
    "furl.*",
    "genshi.*",
    "html2text.*",
    "icalendar.*",
    # FIXME: Do we really need this? We have this implemented ourselves
    #        in OCQMS, so we could just copy that code over... plus the
    #        standard lib technically supports some ISO-8601 formats as well
    "isodate.*",
    "kerberos.*",
    # TODO: Consider switching to fasttext-langdetect
    #       langdetect is really, really slow by comparison...
    "langdetect.*",
    "lazy_object_proxy.*",
    "libres.*",
    "lxml.*",
    "mistletoe.*",
    "more.*",
    "morepath.*",
    "msal.*",
    "pdfdocument.*",
    # FIXME: pypdf has a sane API now and is still maintained
    #        so maybe we should switch to using that
    "pdfrw.*",
    "pdftotext.*",
    "pglast.*",
    # FIXME: Do we need both furl and purl?!
    "purl.*",
    "pyquery.*",
    "qrbill.*",
    "qrcode.*",
    "rcssmin.*",
    "reportlab.*",
    "reg.*",
    "rjsmin.*",
    "sass.*",
    # TODO: Writing stubs for this would probably be really quick
    #       but do we actually have a good use-case for this or
    #       could we just do the sort at the end?
    "sortedcontainers.*",
    "sqlalchemy_utils.*",
    "sqlparse.*",
    "svglib.*",
    "stdnum.*",
    "transaction.*",
    "ua_parser.*",
    # FIXME: This is unmaintained, maybe python-ulid or ulid-transform
    #        would be better to use now?
    "ulid.*",
    "urlextract.*",
    # FIXME: This is unmaintained. I believe WTForms uses email-validate
    #        so we could just use that, since it's already installed...
    "validate_email.*",
    "webassets.*",
    "webtest.*",
    "wtforms.*",
    "wtforms_components.*",
    "xlrd.*",
    "xlsxwriter.*",
    "xsdata_ech.*",
    "xtermcolor.*",
    "yubico_client.*",
    "zope.*"
]
ignore_missing_imports = true


[tool.bandit]
exclude_dirs = [
    "tests",
    "*/**/upgrade.py",
    "*/**/upgrades.py"
]
skips = [
    # ignore asserts
    "B101",
    # ignore pickle (SEA-1030)
    "B301",
    "B403",
    # ignore XML (SEA-1031)
    "B314",
    "B320",
    "B405",
    "B410",
    # ignore subprocesses (SEA-1032)
    "B404",
    "B602",
    "B603",
    "B605",
    "B607",
    # ignore temp directory (SEA-1033)
    "B108"
]

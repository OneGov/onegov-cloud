from collections.abc import Callable, Iterator, Sequence
from typing import Any

class Predicate:
    name: str
    index: Callable[[Any], KeyIndex]
    fallback: Callable | None
    get_key: Callable[[dict[str, Any]], Any] | None
    default: Any | None
    def __init__(
        self, name: str, index: Callable[[Any], KeyIndex], get_key: Callable[[dict[str, Any]], Any] | None = ..., fallback: Callable | None = ..., default: Any | None = ...
    ) -> None: ...
    def create_index(self) -> KeyIndex: ...
    def key_by_predicate_name(self, d: dict) -> Any: ...

def match_key(name: str, func: Callable | None = ..., fallback: Callable | None = ..., default: Any | None = ...) -> Predicate: ...
def match_instance(name: str, func: Callable | None = ..., fallback: Callable | None = ..., default: Any | None = ...) -> Predicate: ...
def match_class(name: str, func: Callable | None = ..., fallback: Callable | None = ..., default: Any | None = ...) -> Predicate: ...

class KeyIndex(dict[Any, Callable]):
    fallback: Callable | None
    def __init__(self, fallback: Callable | None = ...) -> None: ...
    def __missing__(self, key: Any): ...
    def permutations(self, key: Any) -> Iterator[Any]: ...

class ClassIndex(KeyIndex):
    def permutations(self, key: type) -> Iterator[type]: ...

class PredicateRegistry:
    known_keys: set[Any]
    known_values: set[Callable]
    predicates: tuple[Predicate, ...]
    indexes: list[KeyIndex]
    def __init__(self, *predicates: Predicate) -> None: ...
    def register(self, key: Any, value: Callable) -> None: ...
    def get(self, keys: Sequence) -> set[Callable]: ...
    def permutations(self, keys: Sequence) -> Iterator[tuple[Any, ...]]: ...
    def key(self, **kw: Any) -> tuple[Any, ...]: ...
    def key_dict_to_predicate_key(self, d: dict) -> tuple[Any, ...]: ...
    def component(self, keys: Sequence) -> Callable | None: ...
    def fallback(self, keys: Sequence) -> Callable | None: ...
    def all(self, key: Sequence) -> Iterator[Callable]: ...
